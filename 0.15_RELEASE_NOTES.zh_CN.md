## Colyseus 0.15

完整发布记录请见 [发布公告](https://www.colyseus.io/post/announcing-colyseus-0-15).

### [迁移到版本 0.15](https://docs.colyseus.io/colyseus/migrating/0.15/)

**新特性**
- 新引入的房间 `onBeforePatch` 生命周期函数. ([#385](https://github.com/colyseus/colyseus/issues/385))
- Schema: 单属性回调已对所有平台有效!
- 用其 `sessionId` 访问 client 的可能性 ([#443](https://github.com/colyseus/colyseus/issues/443))
- 为 log 的出入数据引入 flag (`DEBUG=colyseus:messages`) ([#465](https://github.com/colyseus/colyseus/issues/465))
- 支持用户自定义日志工具 (使用 `logger:` 服务器参数) ([#442](https://github.com/colyseus/colyseus/issues/442))
- 引入支持原始二进制消息交换 (`room.sendBytes()` / `client.sendBytes()`, [参见示例项目](https://github.com/endel/colyseus-0.15-protocol-buffers))
- 引入 devMode 开发环境中服务器重启时缓存和恢复 state 和客户端连接, 已方便开发迭代工作.

**较大变化**

- [`client.reconnect()` 去除漏洞 和 API 微调](https://docs.colyseus.io/colyseus/migrating/0.15/#clientreconnect-api-slightly-changed)
- [`allowReconnection()`: 第二个参数必须化](https://docs.colyseus.io/colyseus/migrating/0.15/#allowreconnection-second-argument-is-now-mandatory)
- [`@colyseus/loadtest` 完全重写!](https://docs.colyseus.io/colyseus/migrating/0.15/#colyseusloadtest-has-been-reworked)
- [`@colyseus/command` 类型更新](https://docs.colyseus.io/colyseus/migrating/0.15/#colyseuscommand-typings-update)
- [Schema 的 `.triggerAll()` 被废弃.](https://docs.colyseus.io/colyseus/migrating/0.15/#schema-callbacks-api-slightly-changed)
- [Schema 回调 API 修改](https://docs.colyseus.io/colyseus/migrating/0.15/#schema-callbacks-api-slightly-changed)
- [Schema 的 `onChange` 行为修改](https://docs.colyseus.io/colyseus/migrating/0.15/#schemas-onchange-behaviour-change)
- [`MapSchema` 现在使用严格模式访问属性](https://docs.colyseus.io/colyseus/migrating/0.15/#mapschema-is-now-strict-on-property-accessors)

**Bug 修复 / 提升**

- `"redis"` 模块被 `"ioredis"` 取代以便对 `RedisPresence` 和 `RedisDriver` 支持群集 ([#452](https://github.com/colyseus/colyseus/pull/452))
- 修复 matchmaking 当使用 `filterBy` 选项, 过滤条件是 `""`(空字符串) 或者 `null` 的时候, 过滤器返回所有活动房间  ([#342](https://github.com/colyseus/colyseus/issues/342))
- 有限房间属性现在是完全私有 ([#441](https://github.com/colyseus/colyseus/issues/441))
- 修复使用 uWebSockets 传输层时的缩放问题 ([#458](https://github.com/colyseus/colyseus/issues/458))

---

## 新引入的房间 `onBeforePatch` 生命周期函数.

An additional callback has been added for calling before each time the room state is being sent to clients in particular room.

```typescript
export class MyRoom extends Room<MyState> {
  // ...
  onBeforePatch(state: MyState) {
    console.log(state);
  }
  // ...
}
```

# Schema: single property callback is now available on all platforms!

You can now listen to a particular property change on all platforms. This used to be possible only on JavaScript/TypeScript:

```typescript
player.position.listen("x", (value, previousValue) => {/* "x" property changed */})
player.position.listen("y", (value, previousValue) => {/* "y" property changed */})
```

C# equivalent:

```csharp
player.position.OnXChange((value, previousValue) => {/* "x" property changed */});
player.position.OnYChange((value, previousValue) => {/* "y" property changed */});
```

[See full documentation](https://docs.colyseus.io/colyseus/state/schema/#listenprop-callback).

## Introduced log flag for incoming and outgoing messages

For aiding debugging, logging incoming and outgoing messages functionality has been added. You can enable it by using `DEBUG=colyseus:messages` environment variable. (See full documentation on [debug messages](https://docs.colyseus.io/colyseus/debugging/#debug-messages))

```
DEBUG=colyseus:messages
```

## Possibility to access a client directly through its `sessionId`

Previously, to retrieve a particular client by its `sessionId`, you'd need to filter it from the client list:

```typescript
const opponent = this.clients.find((client) => client.sessionId === sessionId);
```

Now, you can access it directly:

```typescript
const opponent = this.clients.get(sessionId);
```

## Support for custom loggers

Node.js has many full-featured loggers, such as [winston](https://www.npmjs.com/package/winston), [bunyan](https://www.npmjs.com/package/bunyan), [pino](https://www.npmjs.com/package/pino), etc. You can now leverage their functionality on internal Colyseus logs. If left unspecified, `console` is used as default logger.

See example below using `winston`:

```typescript
import { Server } from "@colyseus/core";
import * as winston from "winston";

const gameServer = new Server({
    logger: winston.createLogger({
        format: winston.format.combine(
            winston.format.timestamp(),
            winston.format.json(),
        ),
        level: 'info',
        transports: [
            new winston.transports.File({ filename: 'error.log', level: 'error' }),
            new winston.transports.File({ filename: 'all.log' }),
        ],
    })
});
```

**Consuming the logger:**

To consume it, you must import `logger` from `@colyseus/core`, see example below:

```typescript
import { Client, logger } from "@colyseus/core";

export class YourGameRoom extends Room {

  onCreate (options: any) {/* ... */}

  onJoin(client: Client, options: any) {
    logger.info(client.sessionId, "joined!");
  }

  onLeave (client: Client, consented: boolean) {
    logger.info(client.sessionId, "left!");
  }

  onDispose() {
    logger.info("room", this.roomId, "disposing...");
  }
}
```
